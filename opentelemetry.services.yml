parameters:
  tracer_name: drupal.module.opentelemetry.default

services:
  opentelemetry.tracer:
    class: Drupal\opentelemetry\OpentelemetryTracerService
    arguments:
      - '@OpenTelemetry\SDK\Trace\TracerProvider'
      - '%tracer_name%'
      - '@config.factory'
      - '@logger.channel.opentelemetry'
      - '@plugin.manager.opentelemetry_trace'

  OpenTelemetry\SDK\Trace\TracerProvider:
    arguments:
      - '@OpenTelemetry\SDK\Trace\SpanProcessor\SimpleSpanProcessor'

  OpenTelemetry\SDK\Trace\SpanProcessor\SimpleSpanProcessor:
    arguments:
      - '@OpenTelemetry\Contrib\Otlp\SpanExporter'

  OpenTelemetry\Contrib\Otlp\SpanExporter:
    arguments:
      - '@OpenTelemetry\SDK\Common\Export\TransportInterface'

  OpenTelemetry\SDK\Common\Export\TransportInterface:
    factory:
      - '@Drupal\opentelemetry\TransportFactory'
      - 'create'

  Drupal\opentelemetry\TransportFactory:
    arguments:
      - '@OpenTelemetry\Contrib\Otlp\OtlpHttpTransportFactory'
      - '@config.factory'
      - '@logger.channel.opentelemetry'
      - '@messenger'

  OpenTelemetry\Contrib\Otlp\OtlpHttpTransportFactory: {}

  plugin.manager.opentelemetry_trace:
    class: Drupal\opentelemetry\OpentelemetryTraceManager
    parent: default_plugin_manager

  Drupal\opentelemetry\EventSubscriber\RequestTraceEventSubscriber:
    arguments:
      - '@opentelemetry.tracer'
      - '@messenger'
    tags:
      - { name: event_subscriber }

  Drupal\opentelemetry\EventSubscriber\DatabaseStatementTraceEventSubscriber:
    arguments:
      - '@opentelemetry.tracer'
    tags:
      - { name: event_subscriber }

  Drupal\opentelemetry\EventSubscriber\ExceptionTraceEventSubscriber:
    arguments:
      - '@opentelemetry.tracer'
    tags:
      - { name: event_subscriber }

  logger.channel.opentelemetry:
    parent: logger.channel_base
    arguments:
      - 'opentelemetry'
