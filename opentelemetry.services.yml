parameters:
  tracer_name: drupal.module.opentelemetry.default

services:
  logger.channel.opentelemetry:
    parent: logger.channel_base
    arguments:
      - 'opentelemetry'

  opentelemetry:
    class: Drupal\opentelemetry\OpentelemetryService
    arguments:
      - '@opentelemetry.tracer_provider'
      - '%tracer_name%'
      - '@config.factory'
      - '@logger.channel.opentelemetry'
      - '@plugin.manager.opentelemetry_trace'
      - '@request_stack'
      - '@opentelemetry.logger_proxy'
    tags:
      - name: event_subscriber

  opentelemetry.tracer_provider:
    class: OpenTelemetry\SDK\Trace\TracerProvider
    arguments:
      - ['@opentelemetry.span_processor']

  opentelemetry.span_processor:
    class: OpenTelemetry\SDK\Trace\SpanProcessor\SimpleSpanProcessor
    arguments:
      - '@opentelemetry.span_exporter'

  opentelemetry.clock_factory:
    class: OpenTelemetry\SDK\Common\Time\ClockFactory

  opentelemetry.span_exporter:
    class: OpenTelemetry\Contrib\Otlp\SpanExporter
    factory:
      - '@opentelemetry.opentelemetry_span_exporter.factory'
      - 'create'

  opentelemetry.opentelemetry_span_exporter.factory:
    class: Drupal\opentelemetry\OpenTelemetrySpanExporterFactory
    arguments:
      - '@opentelemetry.span_exporter.factory'
      - '@config.factory'
      - '@logger.channel.opentelemetry'
      - '@messenger'

  opentelemetry.span_exporter.factory:
    class: OpenTelemetry\Contrib\Otlp\SpanExporterFactory

  plugin.manager.opentelemetry_trace:
    class: Drupal\opentelemetry\OpentelemetryTraceManager
    parent: default_plugin_manager

  Drupal\opentelemetry\EventSubscriber\RequestTraceEventSubscriber:
    arguments:
      - '@opentelemetry'
      - '@messenger'
      - '@logger.channel.opentelemetry'
    tags:
      - name: event_subscriber

  Drupal\opentelemetry\EventSubscriber\ExceptionTraceEventSubscriber:
    arguments:
      - '@service_container'
    tags:
      - name: event_subscriber

  opentelemetry.logger_proxy:
    class: Drupal\opentelemetry\OpentelemetryLoggerProxy
    arguments:
      - '@logger.channel.opentelemetry'
    tags:
      - name: event_subscriber

  opentelemetry.tracer:
    alias: opentelemetry
    deprecated: The "%alias_id%" alias is deprecated. Renamed to just "opentelemetry" and will be removed in 1.0.
